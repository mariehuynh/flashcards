<html>
<head>
  <title>Algorithms for Philomaths: Flashcards</title>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://static.firebase.com/v0/firebase.js"></script>
  <link rel="stylesheet" type="text/css" href="https://www.firebase.com/css/example.css">
</head>

<body class="cards-body">
  <h1>Firebase Flashcards </h1>
  <div>
    <canvas id="canvas0" width="500" height="350"></canvas>
  </div>
  <input type="button" id="easyButton" value="That was Easy" />
  <input type="button" id="flipButton" value="Flip"          />
  <input type="button" id="hardButton" value="That was Hard" />


<script type="text/javascript">

  var canvas = $("#canvas0").get(0);
  if (!canvas || !canvas.getContext || !canvas.getContext('2d'))
    alert("You must use a browser that supports HTML5 Canvas to run this demo.");

  var Cards = {};

  Cards.start = function() {
    var cardsRef = new Firebase('https://foton.firebaseio.com/');
    var cardsController = new Cards.Controller(cardsRef);
    console.log(cardsController);
  }

  /**
   * Represents a single card
   */
  Cards.Card = function (cardID, jsonCard) {
    this.cardID = cardID;
    this.front = jsonCard.front;
    this.back = jsonCard.back;
    this.notes = jsonCard.notes;
  };

  /**
   * Stores the state of a flashcards stack and handles drawing it.
   */
  Cards.Stack = function (canvas, playerRef) {
    this.playerRef = playerRef;
    this.snapshot = null;

    /*
    // Listen for changes to our board.
    var self = this;
    playerRef.on('value', function(snapshot) {
      self.snapshot = snapshot;
      self.draw();
    });
    */
  };

  Cards.Controller = function (cardsRef) {
    this.cardsRef = cardsRef;

    // FIXME: hardcoded
    this.stackName = "foods_mandarin"
    this.importStack(this.stackName);

    // Start game
    this.play();
  };


  Cards.Controller.prototype.importStack = function (stackName) {
    // load cards
    that = this;
    this.cardsRef.child("cards").child(stackName).once('value', function (snapshot) {
      // get the cards themselves, which are static`
      var tmpCards = snapshot.val();

      // allocate storage and make local alias
      that.cards = new Array(tmpCards.length);
      var cards = that.cards;

      // now bind a listener for card order
      that.cardsRef.child("stackorder").child("foton").child(stackName).on('value', function (snapshot) {
        var tmpOrder = snapshot.val();
        if (tmpOrder === null) {  // no existing order; set a default
          that.cardsRef.child("stackorder").child("foton").child(stackName).set(Object.keys(tmpCards));
          // that set() triggers this callback again, so don't bother updating with the new order now
          return false;
        }
        for (var i=0; i < tmpOrder.length; i++) {
          var card_id = tmpOrder[i];
          cards[i] = new Cards.Card(card_id, tmpCards[card_id]);
        }
        that.displayTopCard('front');
      });
    });
   };


  /**
   * Once we've joined, enable controlling our player.
   */
  Cards.Controller.prototype.play = function () {
    this.canvas = $("#canvas0").get(0);
    this.context = canvas.getContext('2d');
    this.context.textAlign = 'center';

    var self = this;

    $("#easyButton").click(function () {
      self.reinsertTopCard(1);
      self.displayTopCard('front');
    });

    $("#hardButton").click(function () {
      self.reinsertTopCard(0);
      self.displayTopCard('front');
    });

    $("#flipButton").click(function() {
      if(self.state == 'front')
        self.displayTopCard('back');
      else
        self.displayTopCard('front');
    });
  };

  Cards.Controller.prototype.reinsertTopCard = function (easy) {
    var halfLen = this.cards.length / 2;
    var newInd = Math.floor(halfLen * Math.random()) + easy * halfLen;
    var newOrder = new Array(this.cards.length);
    var i = 0;
    for (; i < newInd; i++) {
      newOrder[i] = this.cards[i + 1].cardID;
    }
    newOrder[i++] = this.cards[0].cardID;
    for (; i < this.cards.length; i++) {
      newOrder[i] = this.cards[i].cardID;
    }
    this.cardsRef.child("stackorder").child("foton").child(this.stackName).set(newOrder);
  }

  Cards.Controller.prototype.displayTopCard = function () {
    this.context.font="60px Arial";
    this.context.fillStyle="#000000";
    this.context.fillText(this.cards[0]['front'], 250, 180);
  }

  Cards.Controller.prototype.displayTopCard = function (side) {
    // Clear Canvas
    this.canvas.width = this.canvas.width;

    // Redraw Canvas
    this.context.textAlign = 'center';
    this.context.font="60px Arial";
    this.context.fillStyle="#000000";
    this.context.fillText(this.cards[0][side], 250, 180);
    this.state = side;

    if(side == 'back') {
      this.context.font="35px Arial";
      this.context.fillText(this.cards[0]['notes'], 250,220);
    }
  }

  Cards.start();

</script>
</body>
</html>
